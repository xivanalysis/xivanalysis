import {Excel, Row} from '@kobold/excel'
import {buildKoboldXIV} from '@kobold/xiv'
import fs from 'fs'

main().catch(e => {
	console.error(e)
	process.exit(1)
})

interface UTAStatus {
	id: number
	name: string
	reasons: string[]
}

async function main() {
	// Set up kobold
	const kobold = await buildKoboldXIV()
	const excel = new Excel({kobold})
	const statuses = await excel.getSheet(Status)

	// Build the list of statuses that imply inability to act
	const utaStatuses: UTAStatus[] = []
	for await (const status of statuses.getRows()) {
		if (!status.lockActions && !status.lockControl) {
			continue
		}

		utaStatuses.push({
			id: status.index,
			name: status.name,
			reasons: [
				...status.lockActions ? ['lockActions'] : [],
				...status.lockControl ? ['lockControl'] : [],
			],
		})
	}

	// Codegen
	const statusLines = utaStatuses
		.map(meta => `\t${meta.id}, // ${meta.name} (${meta.reasons.join(', ')})`)
	const fileContents = `// tslint:disable
// This file is automatically generated. Do not edit.
// If you wish to regenerate, run \`yarn generate\`.
export const UNABLE_TO_ACT_STATUS_IDS = [
${statusLines.join('\n')}
]
`

	fs.writeFileSync('./src/generated/unableToActStatusIds.ts', fileContents)
}

class Status extends Row {
	static sheet = 'Status'

	name = this.string()
	description = this.string()
	icon = this.number()
	maxStacks = this.number()
	// unknown UINT_8
	category = this.number({column: 5})
	hitEffect = this.number()
	vfx = this.number()
	lockMovement = this.boolean()
	// unknown PACKED_BOOL_2
	lockActions = this.boolean({column: 10})
	lockControl = this.boolean()
	transfiguration = this.boolean()
	// unknown PACKED_BOOL_5
	canDispel = this.boolean({column: 14})
	inflictedByActor = this.boolean()
	isPermanent = this.boolean()
	partyListPriority = this.number()
	// unknown PACKED_BOOL_1
	// unknown PACKED_BOOL_2
	// unknown INT_16
	// unknown UINT_8
	// unknown PACKED_BOOL_3
	log = this.number({column: 23})
	isFcBuff = this.boolean()
	invisiblity = this.boolean()
	// unknown UINT_8
	// unknown UINT_8
	// unknown PACKED_BOOL_6
}
